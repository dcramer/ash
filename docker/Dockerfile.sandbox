# Sandbox container for executing untrusted code
# This image provides an isolated environment for running bash commands
# with security hardening to contain execution

FROM python:3.12-slim-bookworm

# Build-time arguments for optional packages
ARG EXTRA_APT_PACKAGES=""
ARG EXTRA_PYTHON_PACKAGES=""

# Install common utilities + optional apt packages
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates \
    curl \
    wget \
    jq \
    git \
    vim-tiny \
    less \
    tree \
    unzip \
    ${EXTRA_APT_PACKAGES} \
    && update-ca-certificates \
    && rm -rf /var/lib/apt/lists/* \
    && apt-get clean

# Install uv for fast Python package management
RUN pip install --no-cache-dir uv

# Copy workspace packages
COPY packages/ash-rpc-protocol /tmp/ash-rpc-protocol
COPY packages/ash-sandbox-cli /tmp/ash-sandbox-cli

# Install sandboxed CLI and dependencies (scripts go to /usr/local/bin/ which is on PATH)
RUN uv pip install --system --no-cache \
    /tmp/ash-rpc-protocol \
    /tmp/ash-sandbox-cli \
    ${EXTRA_PYTHON_PACKAGES} \
    && rm -rf /tmp/ash-rpc-protocol /tmp/ash-sandbox-cli \
    && which ash-sb && ash-sb --help  # Verify ash-sb is on PATH and works

# Create non-root user for sandbox execution
RUN useradd -m -s /bin/bash -u 1000 sandbox

# Create working directory with proper ownership
WORKDIR /workspace
RUN chown -R sandbox:sandbox /workspace

# Create sandbox bashrc with security hardening
RUN cat > /home/sandbox/.bashrc << 'BASHRC'
# Ash Sandbox Environment
# This is an isolated container - changes do not persist

# Disable history to prevent leaking sensitive data
unset HISTFILE
HISTSIZE=0
HISTFILESIZE=0

# Clear any existing history
history -c

# Restricted PATH - only essential binaries
export PATH="/usr/local/bin:/usr/bin:/bin"

# Sandbox-aware prompt
PS1='\[\033[1;33m\][sandbox]\[\033[0m\] \[\033[1;34m\]\w\[\033[0m\]\$ '

# Prevent common escape techniques
# Note: These aliases provide friendly error messages. Actual security comes from:
# - cap_drop: ["ALL"] in container config (no CAP_SYS_ADMIN for mount)
# - no-new-privileges security option
# - non-root user (sandbox)
# Bypasses like \mount or /bin/mount will fail at syscall level
alias sudo='echo "sudo: permission denied"'
alias su='echo "su: permission denied"'
alias docker='echo "docker: permission denied"'
alias mount='echo "mount: permission denied"'
alias umount='echo "umount: permission denied"'

# Safety aliases
alias rm='rm -i'
alias mv='mv -i'
alias cp='cp -i'

# Disable job control (prevents background process shenanigans)
set +m

# Read-only functions to prevent tampering
readonly -f command_not_found_handle 2>/dev/null || true
BASHRC

# Create profile that sources bashrc
RUN cat > /home/sandbox/.profile << 'PROFILE'
if [ -f ~/.bashrc ]; then
    . ~/.bashrc
fi
PROFILE

# Set ownership of user files
RUN chown sandbox:sandbox /home/sandbox/.bashrc /home/sandbox/.profile

# Remove setuid/setgid binaries that could be used for privilege escalation
RUN find / -perm /6000 -type f -exec chmod a-s {} \; 2>/dev/null || true

# Switch to non-root user
USER sandbox

# Set environment
ENV HOME=/home/sandbox
ENV USER=sandbox
ENV SHELL=/bin/bash
ENV TERM=xterm-256color
# Minimal PATH
ENV PATH=/usr/local/bin:/usr/bin:/bin
# BASH_ENV ensures .bashrc is sourced for non-interactive shells
# This loads security aliases (mount, sudo, su, docker blocked)
ENV BASH_ENV=/home/sandbox/.bashrc

# Labels for identification
LABEL org.opencontainers.image.title="Ash Sandbox"
LABEL org.opencontainers.image.description="Isolated execution environment for Ash assistant"
LABEL ash.sandbox="true"

# Default command
CMD ["/bin/bash", "--login"]
