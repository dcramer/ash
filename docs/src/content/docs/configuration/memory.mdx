---
title: Memory
description: Configure conversation memory, context management, and extraction
sidebar:
  order: 6
---

import { Aside } from '@astrojs/starlight/components';

Ash stores conversation history and memories in SQLite with semantic search.

## Configuration

```toml
[memory]
database_path = "~/.ash/memory.db"
max_context_messages = 20
context_token_budget = 100000
recency_window = 10
system_prompt_buffer = 8000
```

## Core Options

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `database_path` | path | `"~/.ash/memory.db"` | SQLite database path |
| `max_context_messages` | int | `20` | Maximum messages in context |
| `context_token_budget` | int | `100000` | Target context window size |
| `recency_window` | int | `10` | Always keep last N messages |
| `system_prompt_buffer` | int | `8000` | Reserved tokens for system prompt |
| `auto_gc` | bool | `true` | Run garbage collection on server startup |
| `max_entries` | int | `null` | Cap on active memories (null = unlimited) |

## Context Management

Ash uses smart pruning to fit conversations within token limits:

1. **Recency window** - Last N messages are always included
2. **Token budget** - Older messages pruned to fit budget
3. **System prompt buffer** - Space reserved for instructions

<Aside type="tip">
  Increase `context_token_budget` for longer conversations, but watch API costs.
</Aside>

## Compaction

When context grows too large, Ash summarizes old messages instead of dropping them:

```toml
[memory]
compaction_enabled = true
compaction_reserve_tokens = 16384
compaction_keep_recent_tokens = 20000
compaction_summary_max_tokens = 2000
```

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `compaction_enabled` | bool | `true` | Enable context compaction |
| `compaction_reserve_tokens` | int | `16384` | Buffer before triggering compaction |
| `compaction_keep_recent_tokens` | int | `20000` | Always keep recent context |
| `compaction_summary_max_tokens` | int | `2000` | Max tokens for summary |

When the context exceeds the budget, older messages are summarized by the LLM, preserving important context while reducing tokens.

## Memory Extraction

Ash can automatically extract facts from conversations and store them as memories:

```toml
[memory]
extraction_enabled = true
extraction_model = null  # Use default model
extraction_min_message_length = 20
extraction_debounce_seconds = 30
extraction_confidence_threshold = 0.7
```

| Option | Type | Default | Description |
|--------|------|---------|-------------|
| `extraction_enabled` | bool | `true` | Enable auto memory extraction |
| `extraction_model` | string | `null` | Model for extraction (null = default) |
| `extraction_min_message_length` | int | `20` | Skip short messages |
| `extraction_debounce_seconds` | int | `30` | Min seconds between extractions |
| `extraction_confidence_threshold` | float | `0.7` | Minimum confidence for storing |

<Aside type="note">
  Memory extraction runs in the background after conversations, so it doesn't slow down responses.
</Aside>

## Database Location

The default database is at `~/.ash/memory.db`. Override:

```toml
[memory]
database_path = "/var/lib/ash/memory.db"
```

## Managing Memory

List stored memories:

```bash
uv run ash memory list
```

Search memories:

```bash
uv run ash memory search -q "project ideas"
```

Add a memory:

```bash
uv run ash memory add -q "Remember to check logs daily"
```

Remove a memory:

```bash
uv run ash memory remove --id <uuid>
```

View statistics:

```bash
uv run ash memory stats
```

Run garbage collection:

```bash
uv run ash memory gc
```

## Sessions

Conversations are organized into sessions. View sessions:

```bash
uv run ash sessions list
```

Search message history:

```bash
uv run ash sessions search -q "keyword"
```

Export a session:

```bash
uv run ash sessions export -o backup.json
```

## Database Migrations

Run migrations after updates:

```bash
uv run ash db migrate
```

Check migration status:

```bash
uv run ash db status
```

## Full Example

```toml
[memory]
database_path = "~/.ash/memory.db"

# Context management
max_context_messages = 30
context_token_budget = 150000
recency_window = 15
system_prompt_buffer = 10000

# Compaction
compaction_enabled = true
compaction_reserve_tokens = 20000
compaction_keep_recent_tokens = 25000

# Extraction
extraction_enabled = true
extraction_confidence_threshold = 0.8
extraction_debounce_seconds = 60

# Maintenance
auto_gc = true
max_entries = 1000
```
