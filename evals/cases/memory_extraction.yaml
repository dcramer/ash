schema_version: "2.0"
name: Memory Extraction
description: Tests that explicit "remember" requests store facts with proper classification via the extraction pipeline

defaults:
  agent: memory
  drain_extraction: true
  session:
    provider: telegram
    user_id: eval-user
    username: david
    display_name: "David Cramer"
    chat_type: private

cases:
  - id: extraction_relationship_stored
    description: Remember X is my Y should use memory extract to store a relationship memory
    prompt: "Remember that Sarah is my sister"
    expected_behavior: |
      The agent should use `ash-sb memory extract` (not memory add) to store
      the fact that Sarah is the user's sister. The resulting memory should have
      type=relationship and be linked to a person named Sarah.
    criteria:
      - The agent runs ash-sb memory extract
      - A memory about Sarah being the user's sister is stored
      - The memory has relationship type (not knowledge or identity)
      - A person record for Sarah exists
    expected_tools:
      - bash
    assertions:
      memories:
        - content_contains: [sarah, sister]
          memory_type: relationship
      people:
        - name_contains: sarah
    tags:
      - memory
      - extraction

  - id: extraction_grounding_contextual_rewrite
    description: Multi-turn extraction should ground vague follow-up facts using broader context
    turns:
      - prompt: "Remember this: Randolf is going to Tokyo in May."
        expected_behavior: |
          The assistant should acknowledge and store this memory via extraction.
        criteria:
          - The assistant acknowledges the remember request naturally
          - The assistant does not claim a failure
      - prompt: "Also remember he's still going in May."
        expected_behavior: |
          The assistant should still rely on extraction, and resulting memory content
          should stay grounded to the earlier Tokyo context.
        criteria:
          - The assistant acknowledges the remember request naturally
          - The assistant does not claim a failure
      - prompt: "What did you remember?"
        expected_behavior: |
          The assistant should recall the memory with full context: Randolf going to Tokyo in May.
        criteria:
          - Mentions Randolf
          - Mentions Tokyo
          - Mentions May
    expected_tools:
      - bash
    assertions:
      memories:
        - content_contains: [Randolf, Tokyo, May]
    tags:
      - memory
      - extraction
      - grounding

  - id: extraction_recall_after_store
    description: A fact stored via explicit remember is recallable in a new session
    skip_suite_setup: true
    setup:
      - user_id: eval-user
        username: david
        display_name: "David Cramer"
        chat_type: private
        messages:
          - "Remember that Sarah is my sister"
        drain_extraction: true
    prompt: "What do you know about my sister?"
    expected_behavior: |
      The agent should recall that the user's sister is Sarah, based on the
      memory stored from a previous explicit "remember" request. The response
      should mention Sarah by name.
    criteria:
      - Mentions Sarah by name
      - Identifies Sarah as the user's sister
      - Response is conversational
    tags:
      - memory
      - recall
