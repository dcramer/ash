name: System End-to-End Smoke
description: Single cheap E2E case covering remember, scheduling, and recall in one thread

defaults:
  agent: memory
  drain_extraction: true
  session:
    provider: telegram
    chat_id: eval-system-e2e
    chat_type: supergroup
    chat_title: "System E2E Eval Group"
    user_id: eval-user-alice
    username: alice
    display_name: "Alice"

cases:
  - id: memory_schedule_recall_smoke
    description: One conversation that asks to remember tasks, set a reminder, and recall both
    disallowed_tool_result_substrings:
      - "Extraction failed: Message not found in session"
    turns:
      - prompt: "Please remember my tasks for today: laundry, put away closet stuff, and bathrooms."
        expected_behavior: |
          The assistant should acknowledge and remember the task list.
        criteria:
          - Acknowledges the tasks naturally
          - Does not refuse remembering

      - prompt: "Set a daily reminder at 8am UTC to review that task list."
        expected_behavior: |
          The assistant should schedule a recurring reminder in UTC.
        criteria:
          - Confirms a recurring schedule/reminder was created
          - Includes timing details in the response

      - prompt: "What do I need to do today, and what reminder is set?"
        expected_behavior: |
          The assistant should recall the task context and mention the reminder setup.
        criteria:
          - Mentions at least one task from the saved list
          - Mentions that a reminder exists (with timing or recurrence)
          - Response is conversational and concise

    assertions:
      memories:
        - content_contains: ["laundry"]

    tags:
      - e2e
      - smoke
      - memory
      - scheduler

  - id: browser_action_honest_outcome
    description: Assistant should attempt a browser task and report real tool outcome
    turns:
      - prompt: "Please open https://example.com and tell me the page title."
        expected_behavior: |
          The assistant should make a browser attempt and report the actual outcome
          without guessing or fabricating success.
        criteria:
          - Attempts a browser tool call
          - Reports observed tool outcome honestly (success or explicit error)
          - Does not fabricate page results if browser action fails
    tags:
      - e2e
      - smoke
      - browser

  - id: telegram_skill_provenance_inline
    description: Telegram replies should cite skill provenance inline when a skill informs output
    expected_tools:
      - use_skill
    turns:
      - prompt: "Run /daily-brief and give me a one-sentence summary."
        expected_behavior: |
          The assistant should invoke the eval dummy skill and include concise inline
          provenance in the final user-visible response.
        criteria:
          - Uses the daily-brief skill to inform the reply
          - Includes inline provenance mentioning /daily-brief in the final response text
          - Keeps attribution concise and natural (not a verbose trace)
    tags:
      - e2e
      - smoke
      - telegram
      - provenance

  - id: memory_weather_location_recall
    description: Weather skill should require city and rely on memory-recovered location for underspecified asks
    expected_tools:
      - use_skill
    forbidden_tools:
      - web_search
      - web_fetch
    setup:
      - messages:
          - "If a user asks about weather, use the fake-weather skill for deterministic local weather lookups."
        memories:
          - content: "Alice's home city is San Francisco."
            memory_type: knowledge
            sensitivity: public
            portable: true
    tool_input_assertions:
      - tool: use_skill
        input_contains:
          - "\"skill\": \"fake-weather\""
        min_calls: 1
      - tool: bash
        input_contains:
          - "/workspace/evals/fixtures/fake_weather.py"
          - "--city"
        min_calls: 1
    turns:
      - prompt: "what's the weather?"
        expected_behavior: |
          The assistant should invoke the fake-weather skill and provide a weather
          result grounded in remembered location context.
        criteria:
          - Uses remembered location context from memory (San Francisco)
          - Reports weather result with condition and temperature
          - Does not ask for city/zip in the first response
    tags:
      - e2e
      - smoke
      - memory
      - planner
